<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>ItsOkaytoBuy - Shop Homepage</title>
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.2.3/dist/cosmo/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* Layout and structural styles only - no color theming */
      .product-card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .product-card img {
        height: 180px;
        object-fit: contain;
      }
      
      .card-actions {
        margin-top: auto;
      }
      
      .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
      }
      
      /* Flash animation kept but using theme colors */
        @keyframes flash {
        0%, 100% { background-color: rgba(0, 0, 0, 0); }
        50% { background-color: rgba(var(--bs-primary-rgb), 0.1); }
        }

      .screen-flash {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 9999;
        animation: flash 0.3s 2;
        display: none;
        }

      .screen-flash.show {
        display: block;
        }

      /* Quantity control layout but using theme colors */
      .quantity-control {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: center;
        width: auto;
        max-width: 120px;
      }
      
      .quantity-control .form-control {
        flex: 0 0 auto;
        width: 40px;
        text-align: center;
        border-radius: 0;
        margin: 0 -1px;
        padding-left: 0;
        padding-right: 0;
      }
      
      .quantity-control .btn {
        flex: 0 0 auto;
        min-width: 32px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
      }
      
      /* Card image consistent height */
      .card-img-top {
        height: 200px;
        object-fit: contain;
        padding: 1rem;
        background-color: rgba(var(--bs-light-rgb), 0.4);
      }
      
      /* Product name container */
      .product-name {
        min-height: 40px;
        line-height: 1.3;
        font-weight: bold;
        overflow: hidden;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
      }
      
      /* Floating buttons */
      .floating-buttons {
        position: fixed;
        bottom: 50%;
        right: 1rem;
        transform: translateY(50%);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 1030;
      }
      
      .floating-buttons .btn {
        width: 56px;
        height: 56px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      
      /* Floating search */
      .floating-search-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--bs-body-bg);
          padding: 1rem;
        z-index: 1040;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }
      
      .floating-search-container.show {
        transform: translateY(0);
      }
      
      .floating-search-form {
          display: flex;
        width: 100%;
      }
      
      .floating-search-form .form-control {
        min-height: 48px;
      }
      
      .floating-search-form .btn {
        min-width: 48px;
      }
      
      /* Responsive adjustments - keep only structure and sizing */
      @media (max-width: 768px) {
        .product-card img {
          height: 140px;
        }
        
        .floating-cart {
          display: flex !important;
        }
        
        .top-cart-button {
          display: none;
        }
        
        #productContainer {
          row-gap: 0.75rem !important;
        }
        
        .col.mb-4, .col.mb-5 {
          margin-bottom: 0.75rem !important;
        }
        
        .py-5 {
          padding-top: 2rem !important;
          padding-bottom: 2rem !important;
        }
        
        .mt-5 {
          margin-top: 2rem !important;
        }
        
        .card-body {
          padding-bottom: 0.5rem !important;
        }
      }
      
      @media (max-width: 576px) {
        body {
          padding: 0.5rem !important;
        }
        
        .product-card img {
          height: 120px;
          padding: 0.5rem !important;
        }
        
        .card-body {
          padding: 0.75rem !important;
        }
        
        .card-title {
          font-size: 0.875rem;
          margin-bottom: 0.25rem;
          line-height: 1.2;
        }
        
        .card-text {
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        }
        
        input[type="number"],
        button,
        .btn,
        .form-control {
          min-height: 44px !important;
          font-size: 16px !important;
        }
        
        .card-img-top {
          height: 150px;
        }
        
        .product-name {
          font-size: 0.85rem;
          min-height: 35px;
        }
      }
      
      /* Cart modal specific adjustments */
      #cartItems .quantity-control {
        max-width: 110px;
      }
      
      #cartItems .quantity-control .form-control {
        width: 36px;
      }
      
      #cartItems .quantity-control .btn {
        min-width: 30px;
      }
      
      #cartItems .mt-1 {
        flex-wrap: wrap;
      }
      
      /* Product container spacing */
      #productContainer {
        row-gap: 1rem !important;
      }
      
      @media (min-width: 768px) {
        #productContainer {
          row-gap: 1.5rem !important;
        }
        
        .col.mb-5 {
          margin-bottom: 1rem !important;
        }
        
        .card-footer .quantity-control.input-group {
          margin: 0 auto !important;
        }
        
        .card-footer .d-flex.flex-column {
          align-items: center !important;
        }
        
        .card-footer .d-flex.flex-column .text-center {
        width: 100%;
          margin-top: 0.5rem;
        }
        
        .card-footer .btn-outline-dark.mt-auto {
          min-width: 140px;
        }
      }
      
      /* Very small screens optimizations */
      @media (max-width: 430px) {
        .card-footer.p-2.border-top-0.bg-transparent {
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          gap: 8px !important;
        }
        
        .quantity-control.input-group {
          margin: 0 auto !important;
          max-width: 120px !important;
        }
        
        .card-footer .btn-outline-dark.btn-sm {
          width: 100% !important;
          margin-top: 4px !important;
        }
      }
      
      /* Custom integration with Cosmo theme */
      .btn-brown {
        background-color: var(--bs-primary);
        color: white;
      }
      
      .btn-brown:hover {
        background-color: var(--bs-primary-darker, var(--bs-primary-dark, var(--bs-primary)));
        filter: brightness(90%);
        color: white;
      }
      
      /* Order confirmation section */
      #paymentInstructions .bg-white {
        background-color: var(--bs-body-bg) !important;
      }
    </style>
  </head>
  <body>
    <!-- Header-->
    <header class="bg-primary py-5">
      <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
          <h1 class="display-4 fw-bolder">Daftar Produk</h1>
          <p class="lead fw-normal text-white-50 mb-0">Find what you love</p>
        </div>
      </div>
    </header>

    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
      <div class="container px-4 px-lg-5">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <!-- Category Dropdown -->
          <ul class="navbar-nav me-3 mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="categoryDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Category
              </a>
              <ul class="dropdown-menu" aria-labelledby="categoryDropdown" id="categoryMenu">
                <li><a class="dropdown-item" href="#" onclick="filterByCategory('All')">All</a></li>
                <!-- Categories will be dynamically inserted here -->
              </ul>
            </li>
          </ul>
          <!-- Search form and cart button remain unchanged -->
          <form class="d-flex ms-auto my-2 my-lg-0" role="search">
            <input class="form-control me-2" type="search" id="search" placeholder="Search products..." aria-label="Search" oninput="filterProducts()">
          </form>
          <ul class="navbar-nav ms-3 mb-2 mb-lg-0">
            <li class="nav-item">
              <button class="btn btn-light position-relative" onclick="openCart()">
                <i class="bi bi-cart-fill me-1"></i>
                Cart
                <span class="badge bg-primary text-white ms-1 rounded-pill position-absolute top-0 start-100 translate-middle" id="cartCount" style="font-size:0.8em;">0</span>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Add this after your navbar -->
    <div class="offcanvas offcanvas-top" tabindex="-1" id="offcanvasSearch" aria-labelledby="offcanvasSearchLabel">
      <div class="offcanvas-header">
        <h5 id="offcanvasSearchLabel">Search Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <form class="d-flex" role="search">
          <input class="form-control me-2" type="search" id="offcanvasSearchInput" placeholder="Search products..." aria-label="Search" oninput="syncSearchFields(this.value)">
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="offcanvas">
            <i class="bi bi-x"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Add this after the navbar section -->
    <div id="floatingSearch" class="floating-search-container">
      <div class="container">
        <form class="floating-search-form">
          <input 
            type="search" 
            class="form-control me-2" 
            id="floatingSearchInput" 
            placeholder="Search products..." 
            oninput="syncSearchFields(this.value)"
          >
          <button type="button" class="btn btn-outline-primary" onclick="closeFloatingSearch()">
            <i class="bi bi-x"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Section-->
    <section class="py-5">
      <div class="container px-4 px-lg-5 mt-5">
        <div id="productContainer" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
          <!-- Product cards will be dynamically inserted here by JavaScript -->
        </div>
        <!-- Add pagination controls -->
        <div class="d-flex justify-content-center mt-4">
          <nav aria-label="Product navigation">
            <ul class="pagination" id="paginationContainer">
              <!-- Pagination items will be dynamically inserted here -->
            </ul>
          </nav>
        </div>
    </div>
    </section>

    <!-- Cart Modal -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCart()"></button>
          </div>
          <div class="modal-body">
        <div id="cartItems"></div>
        <div id="cartTotal"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="clearCart()">
              <i class="bi bi-x-circle"></i> Clear All
            </button>
            <button type="button" id="checkoutBtn" class="btn btn-primary" onclick="checkoutCart()">
              <i class="bi bi-cart-check"></i> Checkout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container">
      <div id="toast" class="toast bg-primary text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>
      <span id="toast-message">Item added to cart!</span>
        </div>
      </div>
    </div>

    <div id="screen-flash" class="screen-flash"></div>

    <div class="floating-buttons d-md-none">
      <!-- Example button to trigger search -->
      <button class="btn btn-primary rounded-circle" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSearch" title="Search Products">
        <i class="bi bi-search fs-4"></i>
      </button>
      <button class="btn btn-primary rounded-circle" onclick="openCart()" title="View Cart">
        <i class="bi bi-cart fs-4"></i>
        <span class="badge bg-primary text-white rounded-pill" id="floatingCartCount">0</span>
      </button>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCheckout()"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Order Summary Column -->
              <div class="col-md-5 mb-4 mb-md-0">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Order Summary</h5>
                  </div>
                  <div class="card-body p-3">
                    <div id="checkoutItems" class="mb-3">
                      <!-- Items will be inserted here dynamically -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                      <span>Total:</span>
                      <span id="checkoutTotal"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                      <span>Down Payment:</span>
                      <span id="checkoutDownPayment"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                      <span>Unique code:</span>
                      <span id="checkoutUniqueCode"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center fw-bold mt-2">
                      <span>Paid Now:</span>
                      <span id="checkoutPaidNow"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-2">
                      <span>Shipping:</span>
                      <span>To be calculated later</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Customer Info Column -->
              <div class="col-md-7">
        <form id="checkoutForm">
                  <h5 class="mb-3">Customer Information</h5>
                  <div class="mb-3">
                    <label for="custName" class="form-label">Full Name</label>
                    <input type="text" id="custName" class="form-control" placeholder="Your full name" required>
                  </div>
                  <div class="mb-3">
                    <label for="custPhone" class="form-label">WhatsApp Number</label>
                    <input type="tel" id="custPhone" class="form-control" placeholder="e.g. 81234567890 (without leading 0)" 
                      required pattern="[0-9]+" title="Please enter a valid phone number (numbers only)">
                    <div class="form-text small">Country code +62 will be added automatically</div>
                  </div>
                  <div class="mb-3">
                    <label for="custEmail" class="form-label">Email (optional)</label>
                    <input type="email" id="custEmail" class="form-control" placeholder="your@email.com">
                  </div>
                  <div class="mb-3">
                    <label for="custAddress" class="form-label">Shipping Address</label>
                    <textarea id="custAddress" class="form-control" placeholder="Full delivery address" required rows="3"></textarea>
                  </div>
                  <div class="mb-3">
                    <h6 class="mb-3">Shipping Option</h6>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="shippingOption" id="shippingJNT" value="J&T" checked>
                      <label class="form-check-label" for="shippingJNT">
                        J&T
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="shippingOption" id="shippingShopee" value="Shopee">
                      <label class="form-check-label" for="shippingShopee">
                        Shopee free ongkir <span class="text-muted">(tambah biaya admin 12%)</span>
                      </label>
                    </div>
                  </div>
                  
                  <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="closeCheckout()">
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitOrderBtn">
                      <i class="bi bi-receipt me-1"></i> Submit Order
                    </button>
          </div>
        </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add an Order Confirmation Modal -->
    <div class="modal fade" id="orderConfirmationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Order Confirmed!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <i class="bi bi-check-circle-fill text-primary" style="font-size: 4rem;"></i>
              <h4 class="mt-3">Thank You For Your Order</h4>
              <p class="text-muted">Your order has been received and is being processed.</p>
            </div>
            
            <div class="card mb-3">
              <div class="card-header bg-primary text-white">
                Order Details
              </div>
              <div class="card-body">
                <p class="mb-1"><strong>Order ID:</strong> <span id="confirmOrderId">--</span></p>
                <p class="mb-1"><strong>Date:</strong> <span id="confirmOrderDate">--</span></p>
                <p class="mb-3"><strong>Total:</strong> <span id="confirmOrderTotal">--</span></p>
                
                <div id="paymentInstructions">
                  <!-- Payment instructions will be added here dynamically -->
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="closeCart()">
                Continue Shopping
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer-->
    <footer class="py-5 bg-primary">
      <div class="container"><p class="m-0 text-center text-white">Copyright &copy; ItsOkaytoBuy 2023-2025</p></div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
      let allProducts = [];
      let currentPage = 1;
      const productsPerPage = 16;
      let filteredProducts = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      
      // Add these variables at the top of your script section
      let uniqueCode = 0;
      let downPayment = 0;
      let paidNow = 0;
      
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof bootstrap === 'undefined') {
          console.error('Bootstrap JS is not loaded!');
          alert('Bootstrap JS failed to load');
        } else {
          console.log('Bootstrap JS loaded successfully');
          // Initialize components
          const cartModalEl = document.getElementById('cartModal');
          const cartModal = new bootstrap.Modal(cartModalEl);
          const checkoutModalEl = document.getElementById('checkoutModal');
          const checkoutModal = new bootstrap.Modal(checkoutModalEl);
          const toastEl = document.getElementById('toast');
          const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
          
          // Make these available to global scope
          window.cartModal = cartModal;
          window.checkoutModal = checkoutModal;
          window.toast = toast;
          updateCartCount();
        }
      });

      function formatRupiah(number) {
        return "Rp " + Number(number).toLocaleString("id-ID");
      }

      function renderProducts(products) {
        const start = (currentPage - 1) * productsPerPage;
        const end = start + productsPerPage;
        const paginated = products.slice(start, end);
        const container = document.getElementById("productContainer");
        container.innerHTML = "";
        
        const isExtraCompact = window.innerWidth <= 375;

        paginated.forEach(p => {
          let card;
          
          if (isExtraCompact) {
            // Compact layout for very small screens
            card = `
              <div class="col mb-4">
                <div class="card h-100 border-primary">
                  <!-- Product image-->
                  <img class="card-img-top" 
                       src="${p.imgUrl || 'https://placehold.co/200x200?text=No+Image'}" 
                       alt="${p.name}" 
                       style="height: 140px;" 
                       onerror="this.onerror=null; this.src='https://placehold.co/200x200?text=Error';" />
                  <!-- Product details-->
                  <div class="card-body p-2">
                    <div class="text-center">
                      <!-- Product name-->
                      <h5 class="product-name fw-bolder" title="${p.name}">${p.name}</h5>
                      <!-- Product category -->
                      <div class="text-muted small mb-1">${p.category ? p.category : ''}</div>
                      <!-- Product price-->
                      ${formatRupiah(p.price)}
                    </div>
                  </div>
                  <!-- Product actions-->
                  <div class="card-footer p-2 border-top-0 bg-transparent">
                    <div class="quantity-control input-group" style="max-width: 90px;">
                      <button class="btn btn-outline-primary btn-sm" 
                        onclick="changeQuantity('${p.id}', -1)" 
                        type="button">
                        <i class="bi bi-dash"></i>
                      </button>
                      <input type="number" 
                        min="1" 
                        value="1" 
                        id="qty-${p.id}" 
                        class="form-control" 
                        inputmode="numeric"
                        pattern="[0-9]*"
                      />
                      <button class="btn btn-outline-primary btn-sm" 
                        onclick="changeQuantity('${p.id}', 1)" 
                        type="button">
                        <i class="bi bi-plus"></i>
              </button>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" 
                      onclick="addToCart('${p.id}', ${p.price}, '${encodeURIComponent(p.name)}')">
                      <i class="bi-cart-plus"></i> Add to cart
                    </button>
                  </div>
            </div>
          </div>
        `;
          } else {
            // Original layout for larger screens
            card = `
              <div class="col mb-5">
                <div class="card h-100 border-primary">
                  <!-- Product image-->
                  <img class="card-img-top" 
                       src="${p.imgUrl || 'https://placehold.co/200x200?text=No+Image'}" 
                       alt="${p.name}" 
                       onerror="this.onerror=null; this.src='https://placehold.co/200x200?text=Error';" />
                  <!-- Product details-->
                  <div class="card-body p-4">
                    <div class="text-center">
                      <!-- Product name-->
                      <h5 class="product-name fw-bolder" title="${p.name}">${p.name}</h5>
                      <!-- Product category -->
                      <div class="text-muted small mb-1">${p.category ? p.category : ''}</div>
                      <!-- Product price-->
                      ${formatRupiah(p.price)}
                    </div>
                  </div>
                  <!-- Product actions-->
                  <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                    <div class="d-flex flex-column gap-3">
                      <div class="quantity-control input-group">
                        <button class="btn btn-outline-primary" 
                          onclick="changeQuantity('${p.id}', -1)" 
                          type="button">
                          <i class="bi bi-dash"></i>
                        </button>
                        <input type="number" 
                          min="1" 
                          value="1" 
                          id="qty-${p.id}" 
                          class="form-control" 
                          inputmode="numeric"
                          pattern="[0-9]*"
                        />
                        <button class="btn btn-outline-primary" 
                          onclick="changeQuantity('${p.id}', 1)" 
                          type="button">
                          <i class="bi bi-plus"></i>
                        </button>
                      </div>
                      <div class="text-center">
                        <button class="btn btn-primary mt-auto py-3" style="height:56px"
                          onclick="addToCart('${p.id}', ${p.price}, '${encodeURIComponent(p.name)}')">
                          <i class="bi-cart-plus me-1"></i>
                          Add to cart
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          
          container.innerHTML += card;
        });

        const totalPages = Math.ceil(products.length / productsPerPage);

        renderPagination(Math.ceil(products.length / productsPerPage));
      }

      function filterProducts() {
        const keyword = document.getElementById("search").value.toLowerCase();
        filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(keyword));
        currentPage = 1;
        renderProducts(filteredProducts);
      }

      function changePage(direction) {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        const newPage = currentPage + direction;
        
        // Prevent navigation beyond the first or last page
        if (newPage < 1 || newPage > totalPages) {
          return;
        }
        
        currentPage = newPage;
        renderProducts(filteredProducts);
      }

      function addToCart(productId, price, name) {
        const decodedName = decodeURIComponent(name);
        const qtyInput = document.getElementById(`qty-${productId}`);
        const quantity = parseInt(qtyInput.value) || 1;

        const existing = cart.find(item => item.id === productId);
        if (existing) {
          existing.quantity += quantity;
        } else {
          cart.push({ id: productId, name: decodedName, price, quantity });
        }
        
        qtyInput.value = 1;
        saveCart();
        showToast(`Added ${quantity} × ${decodedName} to cart!`);
      }

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
      }

    function openCart() {
      const cartItems = document.getElementById("cartItems");
      const cartTotal = document.getElementById("cartTotal");
        const checkoutBtn = document.getElementById("checkoutBtn");
      cartItems.innerHTML = "";

      let total = 0;

      if (cart.length === 0) {
        cartItems.innerHTML = "<p>Your cart is empty.</p>";
        cartTotal.innerHTML = "";
          checkoutBtn.style.display = "none";
      } else {
        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          cartItems.innerHTML += `
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                <strong>${item.name}</strong>
                <button onclick="removeFromCart('${encodeURIComponent(item.id)}')" 
                    class="btn btn-sm btn-danger" title="Remove item">
                    <i class="bi bi-x-lg"></i>
                  </button>
              </div>
                <div class="mt-1 d-flex justify-content-between align-items-center">
                  <div class="quantity-control input-group me-2" style="max-width: 140px;">
                    <button class="btn btn-outline-secondary btn-sm" 
                      onclick="updateCartQuantity('${encodeURIComponent(item.id)}', ${item.quantity - 1})" 
                      type="button">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input type="number" min="1" value="${item.quantity}"
                      class="form-control form-control-sm text-center" 
                  onchange="updateCartQuantity('${encodeURIComponent(item.id)}', this.value)">
                    <button class="btn btn-outline-secondary btn-sm" 
                      onclick="updateCartQuantity('${encodeURIComponent(item.id)}', ${item.quantity + 1})" 
                      type="button">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                  <div class="fw-bold">
                    ${formatRupiah(itemTotal)}
                  </div>
              </div>
            </div>
          `;
        });

          cartTotal.innerHTML = `<hr><p class="fs-5 fw-bold">Total: ${formatRupiah(total)}</p>`;
          checkoutBtn.style.display = "inline-block";
      }

        cartModal.show();
    }

      function removeFromCart(productId) {
        const decodedId = decodeURIComponent(productId);
        cart = cart.filter(item => item.id !== decodedId);
        saveCart();
        openCart();
      }

      function updateCartQuantity(productId, newQty) {
        newQty = parseInt(newQty);

        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
          if (newQty <= 0) {
            cart.splice(itemIndex, 1);
          } else {
            cart[itemIndex].quantity = newQty;
          }
        }

        saveCart();
        openCart();
      }

      function closeCart() {
        cartModal.hide();
      }

      function clearCart() {
        cart = [];
        localStorage.removeItem("cart");
        updateCartCount();
      }

      function showToast(message) {
        const messageSpan = document.getElementById("toast-message");
        const screenFlash = document.getElementById("screen-flash");

        messageSpan.textContent = message;

        toast.show();
        
        screenFlash.classList.remove("show");
        void screenFlash.offsetWidth;
        screenFlash.classList.add("show");

        setTimeout(() => {
          screenFlash.classList.remove("show");
        }, 2000);
      }

      function checkoutCart() {
        cartModal.hide();
        
        // Populate the checkout items and total
        updateCheckoutSummary();
        
        // Show the checkout modal
        checkoutModal.show();
      }

      function updateCheckoutSummary() {
        const checkoutItems = document.getElementById('checkoutItems');
        const checkoutTotal = document.getElementById('checkoutTotal');
        const checkoutDownPayment = document.getElementById('checkoutDownPayment');
        const checkoutUniqueCode = document.getElementById('checkoutUniqueCode');
        const checkoutPaidNow = document.getElementById('checkoutPaidNow');
        
        // Clear existing content
        checkoutItems.innerHTML = '';
        
        let total = 0;
        
        // Add CSS styles directly to the head once to avoid duplication
        if (!document.getElementById('checkout-styles')) {
          const styleEl = document.createElement('style');
          styleEl.id = 'checkout-styles';
          styleEl.textContent = `
            .checkout-item {
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 12px;
            }
            .checkout-item-details {
              flex: 1;
            }
            .checkout-item-price {
              text-align: right;
              min-width: 100px;
              font-weight: 500;
            }
            .checkout-item-quantity {
              color: #6c757d;
              font-size: 0.875rem;
            }
            .summary-row {
              display: flex;
              justify-content: space-between;
              margin-bottom: 8px;
            }
            .summary-value {
              text-align: right;
              min-width: 100px;
              font-weight: 500;
            }
            .summary-total {
              font-weight: 700;
            }
          `;
          document.head.appendChild(styleEl);
        }
        
        // Fill the items
        cart.forEach(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          
          checkoutItems.innerHTML += `
            <div class="checkout-item">
              <div class="checkout-item-details">
                <div class="fw-bold">${item.name}</div>
                <div class="checkout-item-quantity">${item.quantity} × ${formatRupiah(item.price)}</div>
              </div>
              <div class="checkout-item-price">${formatRupiah(itemTotal)}</div>
            </div>
          `;
        });
        
        // Generate a random 3-digit unique code between 1-500
        uniqueCode = Math.floor(Math.random() * 500) + 1;
        
        // Calculate down payment (50% of total)
        downPayment = Math.round(total / 2);
        
        // Calculate amount to be paid now (down payment + unique code)
        paidNow = downPayment + uniqueCode;
        
        // Update the summary fields
        checkoutTotal.innerHTML = formatRupiah(total);
        checkoutDownPayment.innerHTML = formatRupiah(downPayment);
        checkoutUniqueCode.innerHTML = formatRupiah(uniqueCode);
        checkoutPaidNow.innerHTML = formatRupiah(paidNow);
        
        // Update the structure of the summary section for better alignment
        const summarySection = checkoutTotal.closest('.card-body');
        const summaryRows = summarySection.querySelectorAll('.d-flex.justify-content-between.align-items-center');
        
        // Add the summary-row class to each row if it exists
        if (summaryRows && summaryRows.length > 0) {
          summaryRows.forEach(row => {
            row.classList.add('summary-row');
            const valueSpan = row.querySelector('span:last-child');
            if (valueSpan) {
              valueSpan.classList.add('summary-value');
            }
          });
          
          // Find the 'paid now' row
          const paidNowRow = Array.from(summaryRows).find(row => 
            row.textContent.toLowerCase().includes('paid now'));
          
          if (paidNowRow) {
            paidNowRow.classList.add('summary-total');
          }
        }
      }

      function closeCheckout() {
        checkoutModal.hide();
      }

        // ✅ Load products with caching
        const CACHE_KEY = "product_cache";
        const CACHE_TIME_KEY = "product_cache_time";
        const CACHE_EXPIRY_MS = 1000 * 60 * 5; // 5 minutes

        const cached = sessionStorage.getItem(CACHE_KEY);
        const cacheTime = sessionStorage.getItem(CACHE_TIME_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const noCache = urlParams.get('nocache') === '1';

      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyavb_FgAhAgAT8enSue64A4mPRv2in0yIxaoIAfRTaum5eLc--BmXjbGW3CWbvdg3q/exec';

        if (!noCache && cached && cacheTime && Date.now() - parseInt(cacheTime) < CACHE_EXPIRY_MS) {
          allProducts = JSON.parse(cached);
          filteredProducts = allProducts;
          renderProducts(filteredProducts);
          populateCategoryMenu();
        } else {
          // Create a JSONP request by dynamically adding a script tag
          const script = document.createElement('script');
          script.src = `${SCRIPT_URL}?action=getProducts&callback=handleProductsResponse`;
          document.body.appendChild(script);
        }

      // Add this function to handle the JSONP response
      function handleProductsResponse(products) {
        sessionStorage.setItem(CACHE_KEY, JSON.stringify(products));
        sessionStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
            allProducts = products;
            filteredProducts = allProducts;
            renderProducts(filteredProducts);
            populateCategoryMenu();
      }

      // Update the checkout form submission handler
      document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get and format the phone number with country code
        let phoneNumber = document.getElementById('custPhone').value.replace(/[^0-9]/g, '');
        if (phoneNumber.startsWith('0')) {
          phoneNumber = phoneNumber.substring(1);
        }
        phoneNumber = '+62' + phoneNumber;
        
        // Disable the submit button and show loading state
        const submitBtn = document.getElementById('submitOrderBtn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
        
        // Calculate total
        const total = calculateCartTotal();
        
        // Generate the order ID here so we can use it in both places
        const timestamp = Date.now().toString().slice(-6);
        const randomPart = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        const generatedOrderId = `ORD-${timestamp}-${randomPart}`;
        
        // Get the selected shipping option
        const shippingOption = document.querySelector('input[name="shippingOption"]:checked').value;
        
        // Prepare the order data
        const orderData = {
          customerName: document.getElementById('custName').value,
          customerEmail: document.getElementById('custEmail').value,
          customerPhone: phoneNumber, // Use the formatted phone number with country code
          customerAddress: document.getElementById('custAddress').value,
          paymentMethod: 'bank_transfer',
          shippingOption: shippingOption,
          cartItems: cart,
          total: total,
          downPayment: paidNow,
          uniqueCode: uniqueCode,
          orderId: generatedOrderId // Add the order ID to the data
        };
        
        // Show the submission is in progress
        showToast("Submitting your order...");
        
        // Use fetch with form-urlencoded data
        const formData = new URLSearchParams();
        formData.append('customerName', orderData.customerName);
        formData.append('customerEmail', orderData.customerEmail);
        formData.append('customerPhone', orderData.customerPhone);
        formData.append('customerAddress', orderData.customerAddress);
        formData.append('paymentMethod', orderData.paymentMethod);
        formData.append('shippingOption', orderData.shippingOption);
        formData.append('cartData', JSON.stringify(orderData.cartItems));
        formData.append('total', orderData.total);
        formData.append('downPayment', orderData.downPayment);
        formData.append('uniqueCode', orderData.uniqueCode);
        formData.append('orderId', generatedOrderId); // Pass the order ID to the backend
        
        fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'no-cors' // Important: Use no-cors mode
        })
        .then(() => {
          // Since no-cors mode doesn't give us response data, we'll just assume success
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          
          // Close checkout modal
          checkoutModal.hide();
          
          // Use the same order ID for the confirmation
          showOrderConfirmation(generatedOrderId, total, 'bank_transfer', shippingOption);
          
          // Clear the cart
          clearCart();
        })
        .catch(error => {
          // Re-enable the submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          
          console.error('Request failed:', error);
          alert('Failed to submit order. Please try again later.');
        });
      });

      function showOrderConfirmation(orderId, total, paymentMethod, shippingOption) {
        // Set order details in confirmation modal
        document.getElementById('confirmOrderId').textContent = orderId || 'Generated on server';
        document.getElementById('confirmOrderDate').textContent = new Date().toLocaleString();
        document.getElementById('confirmOrderTotal').textContent = formatRupiah(total);
        
        // Get customer name for WhatsApp message
        const customerName = document.getElementById('custName').value;
        
        // Set payment instructions based on payment method
        const paymentInstructions = document.getElementById('paymentInstructions');
        
        if (paymentMethod === 'bank_transfer') {
          paymentInstructions.innerHTML = `
            <div class="alert alert-primary mt-3">
              <h5 class="mb-3">Bank Transfer Instructions:</h5>
              <p class="mb-2">Please transfer the down payment of <strong style="font-size: 1.1rem;">${formatRupiah(paidNow)}</strong> (50% of total) to:</p>
              <div class="bg-light p-3 rounded border mb-3" style="user-select: text; -webkit-user-select: text;">
                <p class="mb-2"><strong>Bank:</strong> BANK JAGO</p>
                <p class="mb-2"><strong>Account Number:</strong> <span style="font-size: 1.2rem; font-weight: 600;">105801321294</span></p>
                <p class="mb-0"><strong>Account Name:</strong> <span style="font-size: 1.1rem;">Galuh Ajeng Prabeswari</span></p>
              </div>
              <p class="mb-1">Shipping Option: <strong>${shippingOption}</strong></p>
              <p class="mb-2">Please send the payment confirmation to our WhatsApp:</p>
              <a href="https://wa.me/+6285878024607?text=${encodeURIComponent(`Hai kak, order saya ${customerName} nomor ${orderId} sudah dibayar ya, berikut bukti transfernya`)}" 
                class="btn btn-success btn-lg w-100" 
                target="_blank">
                <i class="bi bi-whatsapp me-2"></i> Send Payment Confirmation
              </a>
            </div>
          `;
        } else if (paymentMethod === 'cod') {
          paymentInstructions.innerHTML = `
            <div class="alert alert-info mt-3">
              <h6>Cash on Delivery:</h6>
              <p class="small mb-0">Please prepare the down payment amount of <strong>${formatRupiah(paidNow)}</strong> when our courier arrives. We'll contact you to confirm delivery details.</p>
            </div>
          `;
        }
        
        // Initialize and show the confirmation modal
        const orderConfirmationModal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
        orderConfirmationModal.show();
      }

      function calculateCartTotal() {
        return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
      }

      // Update the phone number input and handling
      document.getElementById('custPhone').addEventListener('input', function(e) {
        // Remove any non-numeric characters
        let value = this.value.replace(/[^0-9]/g, '');
        
        // If the user manually entered a leading zero, remove it before applying the +62
        if (value.startsWith('0')) {
          value = value.substring(1);
        }
        
        // Show the number in the input without country code for better editing
        this.value = value;
      });

      function updateCartCount() {
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;
        document.getElementById('floatingCartCount').textContent = count;
      }

      function toggleSearchFocus() {
        const floatingSearch = document.getElementById('floatingSearch');
        floatingSearch.classList.add('show');
        
        setTimeout(() => {
          document.getElementById('floatingSearchInput').focus();
        }, 300);
      }

      function closeFloatingSearch() {
        const floatingSearch = document.getElementById('floatingSearch');
        floatingSearch.classList.remove('show');
      }

      function syncSearchFields(value) {
        // Sync the main search field with the floating one
        document.getElementById('search').value = value;
        filterProducts();
      }

      // Add this to your JavaScript (near the bottom, before the closing script tag)
      document.addEventListener('click', function(event) {
        const floatingSearch = document.getElementById('floatingSearch');
        const floatingSearchForm = document.querySelector('.floating-search-form');
        const searchButton = document.querySelector('.floating-buttons .btn:first-child');
        
        // Check if the floating search is visible
        if (floatingSearch.classList.contains('show')) {
          // Check if click is outside the search form and not on the search button
          if (!floatingSearchForm.contains(event.target) && event.target !== searchButton && !searchButton.contains(event.target)) {
            closeFloatingSearch();
          }
        }
      }, true);

      // Add this function after the addToCart function
      function changeQuantity(productId, change) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        let newValue = parseInt(qtyInput.value) + change;
        
        // Ensure minimum value is 1
        if (newValue < 1) newValue = 1;
        
        qtyInput.value = newValue;
      }

      /* Add this function to your JavaScript */
      function applySmallScreenLayout() {
        const container = document.getElementById('productContainer');
        if (window.innerWidth <= 375) {
          container.classList.add('extra-compact');
        } else {
          container.classList.remove('extra-compact');
        }
      }
      
      // Call this on load and on resize
      window.addEventListener('load', applySmallScreenLayout);
      window.addEventListener('resize', applySmallScreenLayout);

      function renderPagination(totalPages) {
        const paginationContainer = document.getElementById('paginationContainer');
        paginationContainer.innerHTML = ''; // Clear existing pagination

        // Previous button
        const prevItem = document.createElement('li');
        prevItem.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
        prevItem.innerHTML = `<button class="page-link" onclick="changePage(-1)" aria-label="Previous">
                              <i class="bi bi-chevron-left"></i>
                            </button>`;
        paginationContainer.appendChild(prevItem);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          const pageItem = document.createElement('li');
          pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
          pageItem.innerHTML = `<button class="page-link" onclick="goToPage(${i})">${i}</button>`;
          paginationContainer.appendChild(pageItem);
        }

        // Next button
        const nextItem = document.createElement('li');
        nextItem.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
        nextItem.innerHTML = `<button class="page-link" onclick="changePage(1)" aria-label="Next">
                              <i class="bi bi-chevron-right"></i>
                            </button>`;
        paginationContainer.appendChild(nextItem);
      }

      function goToPage(pageNumber) {
        currentPage = pageNumber;
        renderProducts(filteredProducts); // Call your function to render products
        renderPagination(Math.ceil(filteredProducts.length / productsPerPage)); // Update pagination
      }

      // Collect unique categories and populate the dropdown
      function populateCategoryMenu() {
        const menu = document.getElementById('categoryMenu');
        // Remove old categories except "All"
        menu.querySelectorAll('li:not(:first-child)').forEach(li => li.remove());
        const categories = Array.from(new Set(allProducts.map(p => p.category).filter(Boolean)));
        categories.forEach(cat => {
          const li = document.createElement('li');
          li.innerHTML = `<a class="dropdown-item" href="#" onclick="filterByCategory('${cat.replace(/'/g, "\\'")}')">${cat}</a>`;
          menu.appendChild(li);
        });
      }

      // Filter products by category
      function filterByCategory(category) {
        if (category === 'All') {
          filteredProducts = allProducts;
        } else {
          filteredProducts = allProducts.filter(p => p.category === category);
        }
        currentPage = 1;
        renderProducts(filteredProducts);
        renderPagination(Math.ceil(filteredProducts.length / productsPerPage));
        // Optionally update dropdown label
        document.getElementById('categoryDropdown').textContent = category;
      }
    </script>
  </body>
</html>
