<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
      body {
        background: #f6f1ea;
      }
      .product-card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .product-card img {
        height: 180px;
        object-fit: contain;
      }
      .card-actions {
        margin-top: auto;
      }
      .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
      }
      @keyframes flash {
        0%, 100% { background-color: rgba(0, 0, 0, 0); }
        50% { background-color: rgba(255, 255, 255, 0.8); }
      }
      .screen-flash {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 9999;
        animation: flash 0.3s 2;
        display: none;
      }
      .screen-flash.show {
        display: block;
      }
      @media (max-width: 768px) {
        .product-card img {
          height: 140px;
        }
        .floating-cart {
          display: flex !important;
        }
        .top-cart-button {
          display: none;
        }
      }
    </style>
  </head>
  <body class="p-4">
    <div class="position-absolute top-0 end-0 m-3 top-cart-button">
      <button class="btn btn-brown" onclick="openCart()" aria-label="View shopping cart">
        <i class="bi bi-cart"></i> View Cartshop
      </button>
    </div>

    <h2 class="mb-3"><i class="bi bi-bag"></i> Daftar Produk</h2>
    <div class="mb-3">
      <input type="text" id="search" class="form-control" placeholder="Search products..." oninput="filterProducts()">
    </div>
    <div id="productContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
    <div class="d-flex justify-content-center mt-3">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <li class="page-item">
            <button class="page-link" onclick="changePage(-1)">Previous</button>
          </li>
          <li class="page-item">
            <span class="page-link" id="pageInfo"></span>
          </li>
          <li class="page-item">
            <button class="page-link" onclick="changePage(1)">Next</button>
          </li>
        </ul>
      </nav>
    </div>

    <!-- Cart Modal -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCart()"></button>
          </div>
          <div class="modal-body">
            <div id="cartItems"></div>
            <div id="cartTotal"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="clearCart()">
              <i class="bi bi-x-circle"></i> Clear All
            </button>
            <button type="button" id="checkoutBtn" class="btn btn-primary" onclick="checkoutCart()">
              <i class="bi bi-cart-check"></i> Checkout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container">
      <div id="toast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>
          <span id="toast-message">Item added to cart!</span>
        </div>
      </div>
    </div>

    <div id="screen-flash" class="screen-flash"></div>

    <div class="position-fixed bottom-0 end-0 m-3 floating-cart d-none">
      <button class="btn btn-brown rounded-circle p-3" onclick="openCart()" title="View Cart">
        <i class="bi bi-cart fs-4"></i>
      </button>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCheckout()"></button>
          </div>
          <div class="modal-body">
            <form id="checkoutForm">
              <div class="mb-3">
                <input type="text" id="custName" class="form-control" placeholder="Name" required>
              </div>
              <div class="mb-3">
                <input type="number" id="custPhone" class="form-control" placeholder="WhatsApp Number" required>
              </div>
              <div class="mb-3">
                <input type="email" id="custEmail" class="form-control" placeholder="Email">
              </div>
              <div class="mb-3">
                <textarea id="custAddress" class="form-control" placeholder="Shipping Address" required rows="3"></textarea>
              </div>
              <div class="text-end">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-receipt"></i> Submit Order
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let allProducts = [];
      let currentPage = 1;
      const productsPerPage = 16;
      let filteredProducts = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      
      // Initialize Bootstrap elements
      const cartModalEl = document.getElementById('cartModal');
      const cartModal = new bootstrap.Modal(cartModalEl);
      const checkoutModalEl = document.getElementById('checkoutModal');
      const checkoutModal = new bootstrap.Modal(checkoutModalEl);
      const toastEl = document.getElementById('toast');
      const toast = new bootstrap.Toast(toastEl, { delay: 2000 });

      function formatRupiah(number) {
        return "Rp " + Number(number).toLocaleString("id-ID");
      }

      function renderProducts(products) {
        const start = (currentPage - 1) * productsPerPage;
        const end = start + productsPerPage;
        const paginated = products.slice(start, end);
        const container = document.getElementById("productContainer");
        container.innerHTML = "";

        paginated.forEach(p => {
          const card = `
            <div class="col">
              <div class="card h-100 product-card">
                <img src="${p.imgUrl}" class="card-img-top p-2" alt="${p.name}">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">${p.name}</h5>
                  <p class="card-text">${formatRupiah(p.price)}</p>
                  <div class="mt-auto">
                    <div class="input-group mb-2">
                      <input type="number" min="1" value="1" id="qty-${p.id}" class="form-control" />
                      <button type="button" class="btn btn-primary" onclick="addToCart('${p.id}', ${p.price}, '${encodeURIComponent(p.name)}')">
                        <i class="bi bi-plus-circle"></i> Add
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          container.innerHTML += card;
        });

        document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${Math.ceil(products.length / productsPerPage)}`;
      }

      function filterProducts() {
        const keyword = document.getElementById("search").value.toLowerCase();
        filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(keyword));
        currentPage = 1;
        renderProducts(filteredProducts);
      }

      function changePage(direction) {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        currentPage += direction;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        renderProducts(filteredProducts);
      }

      function addToCart(productId, price, name) {
        const decodedName = decodeURIComponent(name);
        const qtyInput = document.getElementById(`qty-${productId}`);
        const quantity = parseInt(qtyInput.value) || 1;

        const existing = cart.find(item => item.id === productId);
        if (existing) {
          existing.quantity += quantity;
        } else {
          cart.push({ id: productId, name: decodedName, price, quantity });
        }
        
        qtyInput.value = 1;
        saveCart();
        showToast(`Added ${quantity} Ã— ${decodedName} to cart!`);
      }

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function openCart() {
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const checkoutBtn = document.getElementById("checkoutBtn");
        cartItems.innerHTML = "";

        let total = 0;

        if (cart.length === 0) {
          cartItems.innerHTML = "<p>Your cart is empty.</p>";
          cartTotal.innerHTML = "";
          checkoutBtn.style.display = "none";
        } else {
          cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            cartItems.innerHTML += `
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>${item.name}</strong>
                  <button onclick="removeFromCart('${encodeURIComponent(item.id)}')" 
                    class="btn btn-sm btn-danger" title="Remove item">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                <div class="mt-1">
                  <div class="input-group">
                    <input type="number" min="0" value="${item.quantity}"
                      class="form-control form-control-sm" 
                      onchange="updateCartQuantity('${encodeURIComponent(item.id)}', this.value)">
                    <span class="input-group-text">Ã— ${formatRupiah(item.price)}</span>
                    <span class="input-group-text">${formatRupiah(itemTotal)}</span>
                  </div>
                </div>
              </div>
            `;
          });

          cartTotal.innerHTML = `<hr><p class="fs-5 fw-bold">Total: ${formatRupiah(total)}</p>`;
          checkoutBtn.style.display = "inline-block";
        }

        cartModal.show();
      }

      function removeFromCart(productId) {
        const decodedId = decodeURIComponent(productId);
        cart = cart.filter(item => item.id !== decodedId);
        saveCart();
        openCart();
      }

      function updateCartQuantity(productId, newQty) {
        newQty = parseInt(newQty);

        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
          if (newQty <= 0) {
            cart.splice(itemIndex, 1);
          } else {
            cart[itemIndex].quantity = newQty;
          }
        }

        saveCart();
        openCart();
      }

      function closeCart() {
        cartModal.hide();
      }

      function clearCart() {
        cart = [];
        localStorage.removeItem("cart");
        openCart();
      }

      function showToast(message) {
        const messageSpan = document.getElementById("toast-message");
        const screenFlash = document.getElementById("screen-flash");

        messageSpan.textContent = message;
        
        toast.show();
        
        screenFlash.classList.remove("show");
        void screenFlash.offsetWidth;
        screenFlash.classList.add("show");

        setTimeout(() => {
          screenFlash.classList.remove("show");
        }, 2000);
      }

      function checkoutCart() {
        cartModal.hide();
        checkoutModal.show();
      }

      function closeCheckout() {
        checkoutModal.hide();
      }

      // âœ… Load products with caching
      const CACHE_KEY = "product_cache";
      const CACHE_TIME_KEY = "product_cache_time";
      const CACHE_EXPIRY_MS = 1000 * 60 * 5; // 5 minutes

      const cached = sessionStorage.getItem(CACHE_KEY);
      const cacheTime = sessionStorage.getItem(CACHE_TIME_KEY);
      const urlParams = new URLSearchParams(window.location.search);
      const noCache = urlParams.get('nocache') === '1';

      if (!noCache && cached && cacheTime && Date.now() - parseInt(cacheTime) < CACHE_EXPIRY_MS) {
        allProducts = JSON.parse(cached);
        filteredProducts = allProducts;
        renderProducts(filteredProducts);
      } else {
        google.script.run.withSuccessHandler(products => {
          localStorage.setItem(CACHE_KEY, JSON.stringify(products));
          localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
          allProducts = products;
          filteredProducts = allProducts;
          renderProducts(filteredProducts);
        }).getProducts();
      }

      // Add custom Bootstrap theme color
      document.head.insertAdjacentHTML('beforeend', `
        <style>
          .btn-brown {
            background-color: #3b2314;
            color: white;
          }
          .btn-brown:hover {
            background-color: #523524;
            color: white;
          }
        </style>
      `);
    </script>
  </body>
</html>
