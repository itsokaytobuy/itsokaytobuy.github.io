<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>ItsOkaytoBuy - Shop Homepage</title>
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <style>
      body {
        background: #f6f1ea;
      }
      .product-card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .product-card img {
        height: 180px;
        object-fit: contain;
      }
      .card-actions {
        margin-top: auto;
      }
      .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
      }
      @keyframes flash {
        0%, 100% { background-color: rgba(0, 0, 0, 0); }
        50% { background-color: rgba(255, 255, 255, 0.8); }
      }
      .screen-flash {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 9999;
        animation: flash 0.3s 2;
        display: none;
        }
      .screen-flash.show {
        display: block;
      }
      @media (max-width: 768px) {
        .product-card img {
          height: 140px;
        }
        .floating-cart {
          display: flex !important;
        }
        .top-cart-button {
          display: none;
        }
      }
      @media (max-width: 576px) {
        /* Reduce padding on mobile */
        body {
          padding: 0.5rem !important;
        }

        /* Product card adjustments */
        .product-card {
          height: 100%;
        }

        .product-card img {
          height: 120px;
          object-fit: contain;
          padding: 0.5rem !important;
        }

        .card-body {
          padding: 0.75rem !important;
        }

        .card-title {
          font-size: 0.875rem;
          margin-bottom: 0.25rem;
          line-height: 1.2;
        }

        .card-text {
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        }

        /* Make inputs and buttons more touch-friendly */
        input[type="number"],
        button,
        .btn,
        .form-control {
          min-height: 44px !important; /* Apple's recommended minimum */
          font-size: 16px !important; /* Prevents iOS zoom on focus */
        }

        /* Adjust input groups for better touch */
        .input-group {
        flex-direction: column;
        gap: 0.5rem;
      }

        .input-group > * {
          width: 100% !important;
          border-radius: 0.375rem !important;
        }

        /* Make cart button more prominent */
        .floating-cart {
          bottom: 1rem;
          right: 1rem;
        }

        .floating-cart .btn {
        width: 56px;
        height: 56px;
          padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

        /* Adjust modal content for mobile */
        .modal-body {
          padding: 1rem;
        }

        .modal-footer {
          padding: 1rem;
          flex-direction: column;
          gap: 0.5rem;
        }

        .modal-footer .btn {
          width: 100%;
        }

        /* Adjust pagination for touch */
        .pagination .page-link {
          min-width: 44px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        /* Better spacing for search input */
        .mb-3 {
          margin-bottom: 0.75rem !important;
        }

        /* Adjust heading size */
        h2 {
          font-size: 1.5rem;
          margin-bottom: 1rem;
        }

        .card-img-top {
          height: 150px;  /* Slightly smaller on mobile */
        }

        .product-name {
          font-size: 0.85rem;
          min-height: 35px;
        }

        .quantity-control {
          max-width: none;
        }
        
        .quantity-control .form-control,
        .quantity-control .btn {
          height: 38px;
        }
        
        .input-group {
          flex-direction: row !important;
          width: 100% !important;
        }
        
        .input-group > * {
          width: auto !important;
          border-radius: 0 !important;
        }

        /* Cart modal specific adjustments */
        #cartItems .input-group,
        #cartItems .quantity-control {
          flex-direction: row !important;
          flex-wrap: nowrap !important;
        }
        
        /* Ensure proper alignment in the cart */
        #cartItems .mt-1 {
          flex-wrap: wrap;
        }
        
        /* Make price appear below on very small screens if needed */
        @media (max-width: 380px) {
          #cartItems .mt-1 {
            flex-direction: column !important;
            align-items: flex-start !important;
          }
          
          #cartItems .fw-bold {
            margin-top: 0.5rem;
            align-self: flex-end;
          }
        }
      }

      /* iPhone-specific adjustments */
      @media only screen 
        and (device-width: 430px) 
        and (device-height: 932px) 
        and (-webkit-device-pixel-ratio: 3) {
        
        /* Additional iPhone 14 Pro Max specific styles */
        .product-card {
          margin-bottom: 0.5rem;
        }

        .card-body {
          padding: 0.5rem !important;
        }

        /* Safe area padding for notch/dynamic island */
        .p-4 {
          padding-top: env(safe-area-inset-top) !important;
          padding-bottom: env(safe-area-inset-bottom) !important;
        }
      }

      /* Add to your existing style section */
      .pagination {
        margin: 20px 0;
        display: flex !important;
      }

      /* Add or update in your CSS style section */
      .card-img-top {
        height: 200px;  /* Fixed height for all product images */
        object-fit: contain;  /* Maintains aspect ratio without cropping */
        padding: 1rem;  /* Add some padding around images */
        background-color: white;  /* Optional: clean background for images */
      }

      /* Add this to your CSS styles section */
      .product-name {
        min-height: 40px;       /* Fixed height area for product name */
        line-height: 1.3;       /* Comfortable line spacing */
        font-weight: bold;      /* Restore bold formatting */
        overflow: hidden;       /* Hide overflow */
        font-size: 0.95rem;     /* Slightly smaller font */
        margin-bottom: 0.5rem;
      }

      /* Add to your CSS style section */
      .floating-buttons {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 1030;
      }

      .floating-buttons .btn {
        width: 56px;
        height: 56px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }

      /* Add this to your CSS style section */
      .floating-buttons .badge {
        position: absolute;
        top: 0;
        right: 0;
        transform: translate(25%, -25%);
        font-size: 0.7rem;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .floating-buttons .btn {
        position: relative;
      }

      /* Add these styles to your CSS section */
      .floating-search-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 1rem;
        z-index: 1040;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }

      .floating-search-container.show {
        transform: translateY(0);
      }

      .floating-search-form {
        display: flex;
        width: 100%;
      }

      .floating-search-form .form-control {
        min-height: 48px;
      }

      .floating-search-form .btn {
        min-width: 48px;
      }

      /* Update the quantity control styles to make them more compact */
      .quantity-control {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        width: auto !important; /* Changed from 100% to auto */
        max-width: 120px !important; /* Reduced max-width */
      }
      
      .quantity-control .form-control {
        flex: 0 0 auto !important;
        width: 40px !important; /* Reduced from 50px to 40px */
        text-align: center !important;
        border-radius: 0 !important;
        margin: 0 -1px !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      
      .quantity-control .btn {
        flex: 0 0 auto !important;
        min-width: 32px !important; /* Reduced from 38px to 32px */
        height: 38px !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 1 !important;
      }

      /* Make cart modal quantity controls even smaller */
      #cartItems .quantity-control {
        max-width: 110px !important;
      }
      
      #cartItems .quantity-control .form-control {
        width: 36px !important;
      }
      
      #cartItems .quantity-control .btn {
        min-width: 30px !important;
      }
      
      /* Adjust product card layout for smaller screens */
      @media (max-width: 430px) {
        /* Change the card-footer to use vertical stacking on mobile */
        .card-footer.p-2.border-top-0.bg-transparent {
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          gap: 8px !important;
        }
        
        /* Center the quantity control */
        .quantity-control.input-group {
          margin: 0 auto !important;
          max-width: 120px !important;
        }
        
        /* Make the add button full width */
        .card-footer .btn-outline-dark.btn-sm {
          width: 100% !important;
          margin-top: 4px !important;
        }
      }

      /* Add these updated styles to improve quantity controls for very small screens */
      @media (max-width: 320px) {
        /* Product cards quantity controls */
        .quantity-control {
          display: flex !important;
          justify-content: center !important;
          max-width: 100% !important;
        }
        
        .quantity-control .form-control {
          width: 35px !important;
          padding: 0 !important;
        }
        
        .quantity-control .btn {
          min-width: 30px !important;
        }
        
        /* Make the Add to Cart button smaller text */
        .btn-outline-dark {
          font-size: 14px !important;
          padding: 6px 8px !important;
        }
      }
      
      /* Specific override for the card layout structure */
      @media (max-width: 400px) {
        /* Reduce card padding */
        .card-footer {
          padding: 0.5rem !important;
        }
        
        .product-card .card-body {
          padding-bottom: 0.25rem !important;
        }
        
        /* Center the controls better */
        .card-footer .d-flex.flex-column {
          gap: 0.5rem !important;
        }
        
        /* Maximize space for the numerical input */
        .quantity-control .form-control {
          padding-left: 2px !important;
          padding-right: 2px !important;
        }
        
        /* Make add to cart button take up less vertical space */
        .card-footer .btn.btn-outline-dark.mt-auto {
          padding-top: 6px !important;
          padding-bottom: 6px !important;
          margin-top: 4px !important;
        }
      }
      
      /* Update the compact layout for very small screens */
      @media (max-width: 375px) {
        #productContainer.extra-compact .card-footer {
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
          gap: 8px !important;
        }
      }

      /* Add these styles to reduce spacing between product cards */
      #productContainer {
        row-gap: 1rem !important; /* Reduces vertical gap between cards on all screen sizes */
      }

      /* Desktop specific adjustments */
      @media (min-width: 768px) {
        #productContainer {
          row-gap: 1.5rem !important; /* Slightly more spacing on desktop */
        }
        
        .col.mb-5 {
          margin-bottom: 1rem !important; /* Reduce bottom margin on cards */
        }

        /* Add these styles to center quantity controls in desktop view */
        .card-footer .quantity-control.input-group {
          margin: 0 auto !important;
        }
        
        /* Make sure the quantity control is centered in its container */
        .card-footer .d-flex.flex-column {
          align-items: center !important;
        }
        
        /* Add a little space between quantity control and add button */
        .card-footer .d-flex.flex-column .text-center {
          width: 100%;
          margin-top: 0.5rem;
        }
        
        /* Ensure Add to Cart button maintains consistent width */
        .card-footer .btn-outline-dark.mt-auto {
          min-width: 140px;
        }
        
        /* Proper vertical spacing */
        .card-footer.p-4 {
          padding-top: 1rem !important;
        }
      }

      /* Desktop view specific product card adjustments */
      @media (min-width: 992px) {
        /* Better size for product cards on larger screens */
        .col.mb-5 {
          padding: 0 0.75rem;
        }
        
        /* Clean up padding inside card */
        .card-body.p-4 {
          padding-bottom: 1rem !important;
        }
        
        /* Fix quantity control size consistency */
        .quantity-control.input-group {
          width: 120px !important;
          margin: 0 auto !important;
        }
      }

      /* Mobile specific adjustments */
      @media (max-width: 767px) {
        #productContainer {
          row-gap: 0.75rem !important; /* Even less spacing on mobile */
        }
        
        .col.mb-4, .col.mb-5 {
          margin-bottom: 0.75rem !important; /* Reduce bottom margin on cards */
        }
        
        .py-5 {
          padding-top: 2rem !important; /* Reduce section padding */
          padding-bottom: 2rem !important;
        }
        
        .mt-5 {
          margin-top: 2rem !important; /* Reduce top margin */
        }
        
        /* Adjust vertical spacing in product cards */
        .card-body {
          padding-bottom: 0.5rem !important;
        }
      }

      /* Very small screens */
      @media (max-width: 375px) {
        #productContainer {
          row-gap: 0.5rem !important; /* Minimum spacing on very small screens */
        }
        
        .col.mb-4 {
          margin-bottom: 0.5rem !important;
        }
        
        /* Further reduce padding */
        .card-body.p-2 {
          padding: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container px-4 px-lg-5">
        <a class="navbar-brand" href="#">ItsOkaytoBuy</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <form class="d-flex ms-auto">
            <input class="form-control me-2" type="search" id="search" placeholder="Search products..." oninput="filterProducts()">
          </form>
          <button class="btn btn-outline-dark ms-2" onclick="openCart()">
            <i class="bi-cart-fill me-1"></i>
            Cart
            <span class="badge bg-dark text-white ms-1 rounded-pill" id="cartCount">0</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Add this after the navbar section -->
    <div id="floatingSearch" class="floating-search-container">
      <div class="container">
        <form class="floating-search-form">
          <input 
            type="search" 
            class="form-control me-2" 
            id="floatingSearchInput" 
            placeholder="Search products..." 
            oninput="syncSearchFields(this.value)"
          >
          <button type="button" class="btn btn-outline-dark" onclick="closeFloatingSearch()">
            <i class="bi bi-x"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Header-->
    <header class="bg-dark py-5">
      <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
          <h1 class="display-4 fw-bolder">Daftar Produk</h1>
          <p class="lead fw-normal text-white-50 mb-0">Find what you love</p>
        </div>
      </div>
    </header>
    <!-- Section-->
    <section class="py-5">
      <div class="container px-4 px-lg-5 mt-5">
        <div id="productContainer" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
          <!-- Products will be dynamically inserted here -->
        </div>
        <!-- Add pagination controls -->
        <div class="d-flex justify-content-center mt-4">
          <nav aria-label="Product navigation">
            <ul class="pagination">
              <li class="page-item">
                <button class="page-link" onclick="changePage(-1)">Previous</button>
              </li>
              <li class="page-item">
                <span class="page-link" id="pageInfo">Page 1 of 1</span>
              </li>
              <li class="page-item">
                <button class="page-link" onclick="changePage(1)">Next</button>
              </li>
            </ul>
          </nav>
        </div>
    </div>
    </section>

    <!-- Cart Modal -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCart()"></button>
          </div>
          <div class="modal-body">
        <div id="cartItems"></div>
        <div id="cartTotal"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="clearCart()">
              <i class="bi bi-x-circle"></i> Clear All
            </button>
            <button type="button" id="checkoutBtn" class="btn btn-primary" onclick="checkoutCart()">
              <i class="bi bi-cart-check"></i> Checkout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container">
      <div id="toast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>
      <span id="toast-message">Item added to cart!</span>
        </div>
      </div>
    </div>

    <div id="screen-flash" class="screen-flash"></div>

    <div class="floating-buttons d-md-none">
      <button class="btn btn-brown rounded-circle" onclick="toggleSearchFocus()" title="Search Products">
        <i class="bi bi-search fs-4"></i>
      </button>
      <button class="btn btn-brown rounded-circle" onclick="openCart()" title="View Cart">
        <i class="bi bi-cart fs-4"></i>
        <span class="badge bg-danger text-white rounded-pill" id="floatingCartCount">0</span>
      </button>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCheckout()"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Order Summary Column -->
              <div class="col-md-5 mb-4 mb-md-0">
                <div class="card">
                  <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Order Summary</h5>
                  </div>
                  <div class="card-body p-3">
                    <div id="checkoutItems" class="mb-3">
                      <!-- Items will be inserted here dynamically -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center fw-bold">
                      <span>Total:</span>
                      <span id="checkoutTotal"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-2">
                      <span>Shipping:</span>
                      <span>Will be calculated</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Customer Info Column -->
              <div class="col-md-7">
                <form id="checkoutForm">
                  <h5 class="mb-3">Customer Information</h5>
                  <div class="mb-3">
                    <label for="custName" class="form-label">Full Name</label>
                    <input type="text" id="custName" class="form-control" placeholder="Your full name" required>
                  </div>
                  <div class="mb-3">
                    <label for="custPhone" class="form-label">WhatsApp Number</label>
                    <input type="tel" id="custPhone" class="form-control" placeholder="e.g. 081234567890" required pattern="[0-9]+" title="Please enter a valid phone number (numbers only)">
                  </div>
                  <div class="mb-3">
                    <label for="custEmail" class="form-label">Email (optional)</label>
                    <input type="email" id="custEmail" class="form-control" placeholder="your@email.com">
                  </div>
                  <div class="mb-3">
                    <label for="custAddress" class="form-label">Shipping Address</label>
                    <textarea id="custAddress" class="form-control" placeholder="Full delivery address" required rows="3"></textarea>
                  </div>
                  
                  <h5 class="mb-3 mt-4">Payment Method</h5>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bank_transfer" checked>
                      <label class="form-check-label" for="bankTransfer">
                        Bank Transfer
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
                      <label class="form-check-label" for="cod">
                        Cash on Delivery (COD)
                      </label>
                    </div>
                  </div>
                  
                  <div class="text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="closeCheckout()">
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitOrderBtn">
                      <i class="bi bi-receipt me-1"></i> Submit Order
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add an Order Confirmation Modal -->
    <div class="modal fade" id="orderConfirmationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Order Confirmed!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
              <h4 class="mt-3">Thank You For Your Order</h4>
              <p class="text-muted">Your order has been received and is being processed.</p>
            </div>
            
            <div class="card mb-3">
              <div class="card-header bg-light">
                Order Details
              </div>
              <div class="card-body">
                <p class="mb-1"><strong>Order ID:</strong> <span id="confirmOrderId">--</span></p>
                <p class="mb-1"><strong>Date:</strong> <span id="confirmOrderDate">--</span></p>
                <p class="mb-3"><strong>Total:</strong> <span id="confirmOrderTotal">--</span></p>
                
                <div id="paymentInstructions">
                  <!-- Payment instructions will be added here dynamically -->
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                Continue Shopping
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer-->
    <footer class="py-5 bg-dark">
      <div class="container"><p class="m-0 text-center text-white">Copyright &copy; ItsOkaytoBuy 2023-2025</p></div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
      let allProducts = [];
      let currentPage = 1;
      const productsPerPage = 16;
      let filteredProducts = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof bootstrap === 'undefined') {
          console.error('Bootstrap JS is not loaded!');
          alert('Bootstrap JS failed to load');
        } else {
          console.log('Bootstrap JS loaded successfully');
          // Initialize components
          const cartModalEl = document.getElementById('cartModal');
          const cartModal = new bootstrap.Modal(cartModalEl);
          const checkoutModalEl = document.getElementById('checkoutModal');
          const checkoutModal = new bootstrap.Modal(checkoutModalEl);
          const toastEl = document.getElementById('toast');
          const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
          
          // Make these available to global scope
          window.cartModal = cartModal;
          window.checkoutModal = checkoutModal;
          window.toast = toast;
          updateCartCount();
        }
      });

      function formatRupiah(number) {
        return "Rp " + Number(number).toLocaleString("id-ID");
      }

      function renderProducts(products) {
        const start = (currentPage - 1) * productsPerPage;
        const end = start + productsPerPage;
        const paginated = products.slice(start, end);
        const container = document.getElementById("productContainer");
        container.innerHTML = "";
        
        const isExtraCompact = window.innerWidth <= 375;
        
        paginated.forEach(p => {
          let card;
          
          if (isExtraCompact) {
            // Compact layout for very small screens
            card = `
              <div class="col mb-4">
                <div class="card h-100">
                  <!-- Product image-->
                  <img class="card-img-top" src="${p.imgUrl}" alt="${p.name}" style="height: 140px;" />
                  <!-- Product details-->
                  <div class="card-body p-2">
                    <div class="text-center">
                      <!-- Product name-->
                      <h5 class="product-name fw-bolder" title="${p.name}">${p.name}</h5>
                      <!-- Product price-->
                      ${formatRupiah(p.price)}
                    </div>
                  </div>
                  <!-- Product actions-->
                  <div class="card-footer p-2 border-top-0 bg-transparent">
                    <div class="quantity-control input-group" style="max-width: 90px;">
                      <button class="btn btn-outline-dark btn-sm" 
                        onclick="changeQuantity('${p.id}', -1)" 
                        type="button">
                        <i class="bi bi-dash"></i>
                      </button>
                      <input type="number" 
                        min="1" 
                        value="1" 
                        id="qty-${p.id}" 
                        class="form-control" 
                        inputmode="numeric"
                        pattern="[0-9]*"
                      />
                      <button class="btn btn-outline-dark btn-sm" 
                        onclick="changeQuantity('${p.id}', 1)" 
                        type="button">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                    <button class="btn btn-outline-dark btn-sm w-100" 
                      onclick="addToCart('${p.id}', ${p.price}, '${encodeURIComponent(p.name)}')">
                      <i class="bi-cart-plus"></i> Add to cart
                    </button>
                  </div>
                </div>
              </div>
            `;
          } else {
            // Original layout for larger screens
            card = `
              <div class="col mb-5">
                <div class="card h-100">
                  <!-- Product image-->
                  <img class="card-img-top" src="${p.imgUrl}" alt="${p.name}" />
                  <!-- Product details-->
                  <div class="card-body p-4">
                    <div class="text-center">
                      <!-- Product name-->
                      <h5 class="product-name fw-bolder" title="${p.name}">${p.name}</h5>
                      <!-- Product price-->
                      ${formatRupiah(p.price)}
                    </div>
                  </div>
                  <!-- Product actions-->
                  <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                    <div class="d-flex flex-column gap-2">
                      <div class="quantity-control input-group">
                        <button class="btn btn-outline-dark" 
                          onclick="changeQuantity('${p.id}', -1)" 
                          type="button">
                          <i class="bi bi-dash"></i>
                        </button>
                        <input type="number" 
                          min="1" 
                          value="1" 
                          id="qty-${p.id}" 
                          class="form-control" 
                          inputmode="numeric"
                          pattern="[0-9]*"
                        />
                        <button class="btn btn-outline-dark" 
                          onclick="changeQuantity('${p.id}', 1)" 
                          type="button">
                          <i class="bi bi-plus"></i>
                        </button>
                      </div>
                      <div class="text-center">
                        <button class="btn btn-outline-dark mt-auto" 
                          onclick="addToCart('${p.id}', ${p.price}, '${encodeURIComponent(p.name)}')">
                          <i class="bi-cart-plus me-1"></i>
                          Add to cart
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          
          container.innerHTML += card;
        });

        document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${Math.ceil(products.length / productsPerPage)}`;
      }

      function filterProducts() {
        const keyword = document.getElementById("search").value.toLowerCase();
        filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(keyword));
        currentPage = 1;
        renderProducts(filteredProducts);
      }

      function changePage(direction) {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        currentPage += direction;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        renderProducts(filteredProducts);
      }

      function addToCart(productId, price, name) {
        const decodedName = decodeURIComponent(name);
        const qtyInput = document.getElementById(`qty-${productId}`);
        const quantity = parseInt(qtyInput.value) || 1;

        const existing = cart.find(item => item.id === productId);
        if (existing) {
          existing.quantity += quantity;
        } else {
          cart.push({ id: productId, name: decodedName, price, quantity });
        }
        
        qtyInput.value = 1;
        saveCart();
        showToast(`Added ${quantity} × ${decodedName} to cart!`);
      }

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
      }

    function openCart() {
      const cartItems = document.getElementById("cartItems");
      const cartTotal = document.getElementById("cartTotal");
        const checkoutBtn = document.getElementById("checkoutBtn");
      cartItems.innerHTML = "";

      let total = 0;

      if (cart.length === 0) {
        cartItems.innerHTML = "<p>Your cart is empty.</p>";
        cartTotal.innerHTML = "";
          checkoutBtn.style.display = "none";
      } else {
        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          cartItems.innerHTML += `
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                <strong>${item.name}</strong>
                <button onclick="removeFromCart('${encodeURIComponent(item.id)}')" 
                    class="btn btn-sm btn-danger" title="Remove item">
                    <i class="bi bi-x-lg"></i>
                  </button>
              </div>
                <div class="mt-1 d-flex justify-content-between align-items-center">
                  <div class="quantity-control input-group me-2" style="max-width: 140px;">
                    <button class="btn btn-outline-secondary btn-sm" 
                      onclick="updateCartQuantity('${encodeURIComponent(item.id)}', ${item.quantity - 1})" 
                      type="button">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input type="number" min="1" value="${item.quantity}"
                      class="form-control form-control-sm text-center" 
                  onchange="updateCartQuantity('${encodeURIComponent(item.id)}', this.value)">
                    <button class="btn btn-outline-secondary btn-sm" 
                      onclick="updateCartQuantity('${encodeURIComponent(item.id)}', ${item.quantity + 1})" 
                      type="button">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                  <div class="fw-bold">
                    ${formatRupiah(itemTotal)}
                  </div>
                </div>
            </div>
          `;
        });

          cartTotal.innerHTML = `<hr><p class="fs-5 fw-bold">Total: ${formatRupiah(total)}</p>`;
          checkoutBtn.style.display = "inline-block";
      }

        cartModal.show();
    }

      function removeFromCart(productId) {
        const decodedId = decodeURIComponent(productId);
        cart = cart.filter(item => item.id !== decodedId);
        saveCart();
        openCart();
      }

      function updateCartQuantity(productId, newQty) {
        newQty = parseInt(newQty);

        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
          if (newQty <= 0) {
            cart.splice(itemIndex, 1);
          } else {
            cart[itemIndex].quantity = newQty;
          }
        }

        saveCart();
        openCart();
      }

      function closeCart() {
        cartModal.hide();
      }

      function clearCart() {
        cart = [];
        localStorage.removeItem("cart");
        openCart();
      }

      function showToast(message) {
        const messageSpan = document.getElementById("toast-message");
        const screenFlash = document.getElementById("screen-flash");

        messageSpan.textContent = message;

        toast.show();
        
        screenFlash.classList.remove("show");
        void screenFlash.offsetWidth;
        screenFlash.classList.add("show");

        setTimeout(() => {
          screenFlash.classList.remove("show");
        }, 2000);
      }

      function checkoutCart() {
        cartModal.hide();
        
        // Populate the checkout items and total
        updateCheckoutSummary();
        
        // Show the checkout modal
        checkoutModal.show();
      }

      function updateCheckoutSummary() {
        const checkoutItems = document.getElementById('checkoutItems');
        const checkoutTotal = document.getElementById('checkoutTotal');
        
        checkoutItems.innerHTML = '';
        
        let total = 0;
        
        cart.forEach(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          
          checkoutItems.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span class="fw-bold">${item.name}</span>
                <div class="text-muted small">${item.quantity} × ${formatRupiah(item.price)}</div>
              </div>
              <span>${formatRupiah(itemTotal)}</span>
            </div>
          `;
        });
        
        checkoutTotal.textContent = formatRupiah(total);
      }

      function closeCheckout() {
        checkoutModal.hide();
      }

        // ✅ Load products with caching
        const CACHE_KEY = "product_cache";
        const CACHE_TIME_KEY = "product_cache_time";
        const CACHE_EXPIRY_MS = 1000 * 60 * 5; // 5 minutes

        const cached = sessionStorage.getItem(CACHE_KEY);
        const cacheTime = sessionStorage.getItem(CACHE_TIME_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const noCache = urlParams.get('nocache') === '1';

      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwmBMvBfMVMQ6lhd6h2iNpeSkVsjCzyqTwkWJqtUPReNDjPM0lUqQRZkvixQp6IDB1Lqw/exec';

        if (!noCache && cached && cacheTime && Date.now() - parseInt(cacheTime) < CACHE_EXPIRY_MS) {
          allProducts = JSON.parse(cached);
          filteredProducts = allProducts;
          renderProducts(filteredProducts);
        } else {
        fetch(`${SCRIPT_URL}?action=getProducts`)
          .then(response => response.json())
          .then(products => {
            sessionStorage.setItem(CACHE_KEY, JSON.stringify(products));
            sessionStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
            allProducts = products;
            filteredProducts = allProducts;
            renderProducts(filteredProducts);
          })
          .catch(error => {
            console.error('Error fetching products:', error);
          });
      }

      // Add checkout form submission handler:
      document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Disable the submit button and show loading state
        const submitBtn = document.getElementById('submitOrderBtn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
        
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        const payload = {
          customer: {
            name: document.getElementById('custName').value,
            email: document.getElementById('custEmail').value,
            phone: document.getElementById('custPhone').value,
            address: document.getElementById('custAddress').value
          },
          payment: {
            method: paymentMethod
          },
          cart: cart
        };
        
        fetch(SCRIPT_URL, {
          method: 'POST',
      headers: {
            'Content-Type': 'application/json'
      },
          body: JSON.stringify(payload)
    })
        .then(response => response.json())
      .then(data => {
        // Re-enable the submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        
        if (data.success) {
            // Close checkout modal
            checkoutModal.hide();
            
            // Show confirmation with order details
            showOrderConfirmation(data.orderId, data.total, paymentMethod);
            
            // Clear the cart
            clearCart();
        } else {
            console.error('Error:', data.error);
            alert('Order failed: ' + data.error);
          }
        })
        .catch(error => {
          // Re-enable the submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          
          console.error('Request failed:', error);
          alert('Failed to submit order. Try again later.');
        });
      });

      function showOrderConfirmation(orderId, total, paymentMethod) {
        // Set order details in confirmation modal
        document.getElementById('confirmOrderId').textContent = orderId || 'Generated on server';
        document.getElementById('confirmOrderDate').textContent = new Date().toLocaleString();
        document.getElementById('confirmOrderTotal').textContent = formatRupiah(total || calculateCartTotal());
        
        // Set payment instructions based on payment method
        const paymentInstructions = document.getElementById('paymentInstructions');
        
        if (paymentMethod === 'bank_transfer') {
          paymentInstructions.innerHTML = `
            <div class="alert alert-info mt-3">
              <h6>Bank Transfer Instructions:</h6>
              <p class="small mb-1">Please transfer the payment to:</p>
              <p class="small mb-1"><strong>Bank:</strong> BCA</p>
              <p class="small mb-1"><strong>Account Number:</strong> 1234567890</p>
              <p class="small mb-1"><strong>Account Name:</strong> ItsOkaytoBuy</p>
              <p class="small mb-0">Please send the payment confirmation to our WhatsApp: +6281234567890</p>
            </div>
          `;
        } else if (paymentMethod === 'cod') {
          paymentInstructions.innerHTML = `
            <div class="alert alert-info mt-3">
              <h6>Cash on Delivery:</h6>
              <p class="small mb-0">Please prepare the exact amount when our courier arrives. We'll contact you to confirm delivery details.</p>
            </div>
          `;
        }
        
        // Initialize and show the confirmation modal
        const orderConfirmationModal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
        orderConfirmationModal.show();
      }

      function calculateCartTotal() {
        return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
      }

      // Add this function to validate phone number as the user types
      document.getElementById('custPhone').addEventListener('input', function(e) {
        // Remove any non-numeric characters
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // Add custom Bootstrap theme color
      document.head.insertAdjacentHTML('beforeend', `
        <style>
          .btn-brown {
            background-color: #3b2314;
            color: white;
          }
          .btn-brown:hover {
            background-color: #523524;
            color: white;
          }
        </style>
      `);

      function updateCartCount() {
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;
        document.getElementById('floatingCartCount').textContent = count;
      }

      function toggleSearchFocus() {
        const floatingSearch = document.getElementById('floatingSearch');
        floatingSearch.classList.add('show');
        
        setTimeout(() => {
          document.getElementById('floatingSearchInput').focus();
        }, 300);
      }

      function closeFloatingSearch() {
        const floatingSearch = document.getElementById('floatingSearch');
        floatingSearch.classList.remove('show');
      }

      function syncSearchFields(value) {
        // Sync the main search field with the floating one
        document.getElementById('search').value = value;
        filterProducts();
      }

      // Add this to your JavaScript (near the bottom, before the closing script tag)
      document.addEventListener('click', function(event) {
        const floatingSearch = document.getElementById('floatingSearch');
        const floatingSearchForm = document.querySelector('.floating-search-form');
        const searchButton = document.querySelector('.floating-buttons .btn:first-child');
        
        // Check if the floating search is visible
        if (floatingSearch.classList.contains('show')) {
          // Check if click is outside the search form and not on the search button
          if (!floatingSearchForm.contains(event.target) && event.target !== searchButton && !searchButton.contains(event.target)) {
            closeFloatingSearch();
          }
        }
      }, true);

      // Add this function after the addToCart function
      function changeQuantity(productId, change) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        let newValue = parseInt(qtyInput.value) + change;
        
        // Ensure minimum value is 1
        if (newValue < 1) newValue = 1;
        
        qtyInput.value = newValue;
      }

      /* Add this function to your JavaScript */
      function applySmallScreenLayout() {
        const container = document.getElementById('productContainer');
        if (window.innerWidth <= 375) {
          container.classList.add('extra-compact');
        } else {
          container.classList.remove('extra-compact');
        }
      }
      
      // Call this on load and on resize
      window.addEventListener('load', applySmallScreenLayout);
      window.addEventListener('resize', applySmallScreenLayout);
    </script>
  </body>
</html>
